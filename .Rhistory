library(sf)
library(terra)
library(ggpubr)
library(cowplot)
library(imager)
library(grid) # for images
library(magick) # for images
library(gt)
## Figure 3. Example sampling designs -----------------------------------------
create_sampling_design_plot <- function(sf_data, sampling_area, SZ, aus, samples_sf, colour_palette, legend = TRUE) {
p <- ggplot() +
geom_sf(data = sf_data, aes(fill = as.factor(detrended)), colour = NA) +
scale_fill_manual(values = c("0" = "#F5F5F5", "1" = "#E0E0E0", "2" = "#9E9E9E"),
na.value = NA,
labels = c("0" = "Strata 1\n(low)",
"1" = "Strata 2\n(medium)",
"2" = "Strata 3\n(high)")) +
labs(fill = "Detrended\nbathymetry") +
geom_sf(data = SZ, aes(colour = "Simulated\nNTZ"), fill = NA, linewidth = 1) +
geom_sf(data = land, color = "darkgray", fill = 'lightgray', size = 0.2) +
geom_sf(data = samples_sf, aes(colour = "Simulated\nsample points"), size = 1) +
coord_sf(crs = 4326, xlim = ext(sampling_area)[1:2], ylim = ext(sampling_area)[3:4]) +
scale_color_manual(name = '', values = c('Simulated\nsample points' = colour_palette[6],
'Simulated\nNTZ' = colour_palette[2])) +
custom_theme +
theme(
axis.text.x = element_blank(),  # Explicitly remove x-axis text
axis.text.y = element_blank(),  # Explicitly remove y-axis text
axis.ticks = element_blank(),   # Remove axis ticks
axis.title.x = element_blank(), # Remove x-axis title
axis.title.y = element_blank(),  # Remove y-axis title
legend.position = "top",
plot.margin = margin(0, 0, 0, 0, "cm")
)
}
# WAATERN example designs
study_site <- "waatern"
target_crs <- 4326
SZ                  <- st_read(paste0("QGIS layers/clean/", study_site, "_simulated_SZ.shp")) %>% st_transform(crs=target_crs) # simulated SZ shapefile
sampling_area_waatern <- st_read(paste0("QGIS layers/clean/", study_site, "_simulated_SZ_sampling_area.shp")) %>% st_transform(crs=target_crs) # simulation area
sf_all              <- readRDS(paste0("outputs/distribution_modelling_outputs/D04_", study_site, "_sample_area_detrended_strata.rds")) %>% st_transform(crs=target_crs) # detrended bathymetry strata in the simulation area
samples_sf_rand     <- readRDS(paste0('outputs/distribution_modelling_outputs/D04_sampling_designs/D04_', study_site, '_example_sampling_design_simple_spatial_balance.rds')) %>% st_transform(crs=target_crs)# example points for simulated random design
samples_sf_pref_2525<- readRDS(paste0('outputs/distribution_modelling_outputs/D04_sampling_designs/D04_', study_site, '_example_sampling_design_preferential_25_25.rds')) %>% st_transform(crs=target_crs) # example points for simulated preferential design
samples_sf_pref_2030<- readRDS(paste0('outputs/distribution_modelling_outputs/D04_sampling_designs/D04_', study_site,'_example_sampling_design_preferential_20_30.rds')) %>% st_transform(crs=target_crs) # example points for simulated preferential design
samples_sf_sb_2525  <- readRDS(paste0("outputs/distribution_modelling_outputs/D04_sampling_designs/D04_", study_site, "_example_sampling_design_stratified_spatial_balance_25_25.rds")) %>% st_transform(crs=target_crs) # example points for simulated spatially balanced design
samples_sf_sb_2030  <- readRDS(paste0('outputs/distribution_modelling_outputs/D04_sampling_designs/D04_', study_site, '_example_sampling_design_stratified_spatial_balance_20_30.rds')) %>% st_transform(crs=target_crs) # example points for simulated spatially balanced design
samples_sf_clump    <- readRDS(paste0('outputs/distribution_modelling_outputs/D04_sampling_designs/D04_', study_site, '_example_sampling_design_clustered.rds')) %>% st_transform(crs=target_crs) # example points for simulated clustered design
# make the subplots
waatern_ex_rand <- create_sampling_design_plot(sf_all, sampling_area_waatern, SZ, aus, samples_sf_rand, colour_palette, legend = TRUE)
land <- st_read("QGIS layers/clean/wadandi_land_highres.shp"); plot(land$geometry)
create_sampling_design_plot <- function(sf_data, sampling_area, SZ, aus, samples_sf, colour_palette, legend = TRUE) {
p <- ggplot() +
geom_sf(data = sf_data, aes(fill = as.factor(detrended)), colour = NA) +
scale_fill_manual(values = c("0" = "#F5F5F5", "1" = "#E0E0E0", "2" = "#9E9E9E"),
na.value = NA,
labels = c("0" = "Strata 1\n(low)",
"1" = "Strata 2\n(medium)",
"2" = "Strata 3\n(high)")) +
labs(fill = "Detrended\nbathymetry") +
geom_sf(data = SZ, aes(colour = "Simulated\nNTZ"), fill = NA, linewidth = 1) +
geom_sf(data = land, color = "darkgray", fill = 'lightgray', size = 0.2) +
geom_sf(data = samples_sf, aes(colour = "Simulated\nsample points"), size = 1) +
coord_sf(crs = 4326, xlim = ext(sampling_area)[1:2], ylim = ext(sampling_area)[3:4]) +
scale_color_manual(name = '', values = c('Simulated\nsample points' = colour_palette[6],
'Simulated\nNTZ' = colour_palette[2])) +
custom_theme +
theme(
axis.text.x = element_blank(),  # Explicitly remove x-axis text
axis.text.y = element_blank(),  # Explicitly remove y-axis text
axis.ticks = element_blank(),   # Remove axis ticks
axis.title.x = element_blank(), # Remove x-axis title
axis.title.y = element_blank(),  # Remove y-axis title
legend.position = "top",
plot.margin = margin(0, 0, 0, 0, "cm")
)
}
study_site <- "waatern"
target_crs <- 4326
SZ                  <- st_read(paste0("QGIS layers/clean/", study_site, "_simulated_SZ.shp")) %>% st_transform(crs=target_crs) # simulated SZ shapefile
sampling_area_waatern <- st_read(paste0("QGIS layers/clean/", study_site, "_simulated_SZ_sampling_area.shp")) %>% st_transform(crs=target_crs) # simulation area
sf_all              <- readRDS(paste0("outputs/distribution_modelling_outputs/D04_", study_site, "_sample_area_detrended_strata.rds")) %>% st_transform(crs=target_crs) # detrended bathymetry strata in the simulation area
samples_sf_rand     <- readRDS(paste0('outputs/distribution_modelling_outputs/D04_sampling_designs/D04_', study_site, '_example_sampling_design_simple_spatial_balance.rds')) %>% st_transform(crs=target_crs)# example points for simulated random design
samples_sf_pref_2525<- readRDS(paste0('outputs/distribution_modelling_outputs/D04_sampling_designs/D04_', study_site, '_example_sampling_design_preferential_25_25.rds')) %>% st_transform(crs=target_crs) # example points for simulated preferential design
samples_sf_pref_2030<- readRDS(paste0('outputs/distribution_modelling_outputs/D04_sampling_designs/D04_', study_site,'_example_sampling_design_preferential_20_30.rds')) %>% st_transform(crs=target_crs) # example points for simulated preferential design
samples_sf_sb_2525  <- readRDS(paste0("outputs/distribution_modelling_outputs/D04_sampling_designs/D04_", study_site, "_example_sampling_design_stratified_spatial_balance_25_25.rds")) %>% st_transform(crs=target_crs) # example points for simulated spatially balanced design
samples_sf_sb_2030  <- readRDS(paste0('outputs/distribution_modelling_outputs/D04_sampling_designs/D04_', study_site, '_example_sampling_design_stratified_spatial_balance_20_30.rds')) %>% st_transform(crs=target_crs) # example points for simulated spatially balanced design
samples_sf_clump    <- readRDS(paste0('outputs/distribution_modelling_outputs/D04_sampling_designs/D04_', study_site, '_example_sampling_design_clustered.rds')) %>% st_transform(crs=target_crs) # example points for simulated clustered design
# make the subplots
waatern_ex_rand <- create_sampling_design_plot(sf_all, sampling_area_waatern, SZ, aus, samples_sf_rand, colour_palette, legend = TRUE)
waatern_ex_spabal_2525 <- create_sampling_design_plot(sf_all, sampling_area_waatern, SZ, aus, samples_sf_sb_2525, colour_palette, legend = TRUE)
waatern_ex_spabal_2030 <- create_sampling_design_plot(sf_all, sampling_area_waatern, SZ, aus, samples_sf_sb_2030, colour_palette, legend = TRUE)
waatern_ex_pref_2525 <- create_sampling_design_plot(sf_all, sampling_area_waatern, SZ, aus, samples_sf_pref_2525, colour_palette, legend = TRUE)
waatern_ex_pref_2030 <- create_sampling_design_plot(sf_all, sampling_area_waatern, SZ, aus, samples_sf_pref_2030, colour_palette, legend = TRUE)
waatern_ex_clump <- create_sampling_design_plot(sf_all, sampling_area_waatern, SZ, aus, samples_sf_clump, colour_palette, legend = FALSE)
# WAATU example designs
# Load layers
study_site <- "waatu"
target_crs <- 4326
SZ                  <- st_read(paste0("QGIS layers/clean/", study_site, "_simulated_SZ.shp")) %>% st_transform(crs=target_crs) # simulated SZ shapefile
sampling_area_waatu <- st_read(paste0("QGIS layers/clean/", study_site, "_simulated_SZ_sampling_area.shp")) %>% st_transform(crs=target_crs) # simulation area
sf_all              <- readRDS(paste0("outputs/distribution_modelling_outputs/D04_", study_site, "_sample_area_detrended_strata.rds")) %>% st_transform(crs=target_crs) # detrended bathymetry strata in the simulation area
samples_sf_rand     <- readRDS(paste0('outputs/distribution_modelling_outputs/D04_sampling_designs/D04_', study_site, '_example_sampling_design_simple_spatial_balance.rds')) %>% st_transform(crs=target_crs)# example points for simulated random design
samples_sf_pref_2525<- readRDS(paste0('outputs/distribution_modelling_outputs/D04_sampling_designs/D04_', study_site, '_example_sampling_design_preferential_25_25.rds')) %>% st_transform(crs=target_crs) # example points for simulated preferential design
samples_sf_pref_2030<- readRDS(paste0('outputs/distribution_modelling_outputs/D04_sampling_designs/D04_', study_site,'_example_sampling_design_preferential_20_30.rds')) %>% st_transform(crs=target_crs) # example points for simulated preferential design
samples_sf_sb_2525  <- readRDS(paste0("outputs/distribution_modelling_outputs/D04_sampling_designs/D04_", study_site, "_example_sampling_design_stratified_spatial_balance_25_25.rds")) %>% st_transform(crs=target_crs) # example points for simulated spatially balanced design
samples_sf_sb_2030  <- readRDS(paste0('outputs/distribution_modelling_outputs/D04_sampling_designs/D04_', study_site, '_example_sampling_design_stratified_spatial_balance_20_30.rds')) %>% st_transform(crs=target_crs) # example points for simulated spatially balanced design
samples_sf_clump    <- readRDS(paste0('outputs/distribution_modelling_outputs/D04_sampling_designs/D04_', study_site, '_example_sampling_design_clustered.rds')) %>% st_transform(crs=target_crs) # example points for simulated clustered design
pred_PS      <- as.data.frame(readRDS(paste0("outputs/distribution_modelling_outputs/D05_SZ_increase_distribution_rasters/D05_", study_site, "_SZ_increase_predicted_abundance_Sparidae_Chrysophrys_auratus.rds")), xy=TRUE)
pred_SMW     <- as.data.frame(readRDS(paste0("outputs/distribution_modelling_outputs/D05_SZ_increase_distribution_rasters/D05_", study_site, "_SZ_increase_predicted_abundance_Labridae_Ophthalmolepis_lineolatus.rds")), xy=TRUE)
pred_WAD     <- as.data.frame(readRDS(paste0("outputs/distribution_modelling_outputs/D05_SZ_increase_distribution_rasters/D05_", study_site, "_SZ_increase_predicted_abundance_Glaucosomatidae_Glaucosoma_hebraicum.rds")), xy=TRUE)
# make the subplots
waatu_ex_rand <- create_sampling_design_plot(sf_all, sampling_area_waatu, SZ, aus, samples_sf_rand, colour_palette, legend = TRUE)
waatu_ex_spabal_2525 <- create_sampling_design_plot(sf_all, sampling_area_waatu, SZ, aus, samples_sf_sb_2525, colour_palette, legend = TRUE)
waatu_ex_spabal_2030 <- create_sampling_design_plot(sf_all, sampling_area_waatu, SZ, aus, samples_sf_sb_2030, colour_palette, legend = TRUE)
waatu_ex_pref_2525 <- create_sampling_design_plot(sf_all, sampling_area_waatu, SZ, aus, samples_sf_pref_2525, colour_palette, legend = TRUE)
waatu_ex_pref_2030 <- create_sampling_design_plot(sf_all, sampling_area_waatu, SZ, aus, samples_sf_pref_2030, colour_palette, legend = TRUE)
waatu_ex_clump <- create_sampling_design_plot(sf_all, sampling_area_waatu, SZ, aus, samples_sf_clump, colour_palette, legend = FALSE)
# combine all example SDs
ex_maps <- ggarrange(
waatern_ex_rand + theme(legend.position = "top") + annotate("text", x = ext(sampling_area_waatern)[1],y = ext(sampling_area_waatern)[4], label = "simple sp. balanced", hjust = 0, vjust = 0.5, size = 3),
waatern_ex_spabal_2030 + theme(legend.position = "top") + annotate("text", x = ext(sampling_area_waatern)[1], y = ext(sampling_area_waatern)[4], label = "str. sp. balanced (20/30)", hjust = 0, vjust = 0.5, size = 3),
waatern_ex_spabal_2525 + theme(legend.position = "top") + annotate("text", x = ext(sampling_area_waatern)[1], y = ext(sampling_area_waatern)[4], label = "str. sp. balanced (25/25)", hjust = 0, vjust = 0.5, size = 3),
waatu_ex_rand + theme(legend.position = "top") + annotate("text", x = ext(sampling_area_waatu)[2], y = ext(sampling_area_waatu)[3], label = "simple sp. balanced", hjust = 0, vjust = -0.5, size = 3, angle = 90),
waatu_ex_spabal_2030 + theme(legend.position = "top") + annotate("text", x = ext(sampling_area_waatu)[2], y = ext(sampling_area_waatu)[3], label = "str. sp. balanced (20/30)", hjust = 0, vjust = -0.5, size = 3, angle = 90),
waatu_ex_spabal_2525 + theme(legend.position = "top") + annotate("text", x = ext(sampling_area_waatu)[2], y = ext(sampling_area_waatu)[3], label = "str. sp. balanced (25/25)", hjust = 0, vjust = -0.5,size = 3, angle = 90),
waatern_ex_pref_2030 + theme(legend.position = "none") + annotate("text", x = ext(sampling_area_waatern)[1], y = ext(sampling_area_waatern)[4], label = " preferential (20/30)", hjust = 0, vjust = 0.5, size = 3),
waatern_ex_pref_2525 + theme(legend.position = "none") + annotate("text", x = ext(sampling_area_waatern)[1], y = ext(sampling_area_waatern)[4],  label = " preferential (25/25)", hjust = 0, vjust = 0.5, size = 3),
waatern_ex_clump + theme(legend.position = "none") + annotate("text", x = ext(sampling_area_waatern)[1], y = ext(sampling_area_waatern)[4], label = "clustered", hjust = 0, vjust = 0.5, size = 3),
waatu_ex_pref_2030 + theme(legend.position = "none") + annotate("text", x = ext(sampling_area_waatu)[2], y = ext(sampling_area_waatu)[3], label = " preferential (20/30)", hjust = 0, vjust = -0.5, size = 3, angle = 90),
waatu_ex_pref_2525 + theme(legend.position = "none") + annotate("text", x = ext(sampling_area_waatu)[2], y = ext(sampling_area_waatu)[3], label = " preferential (25/25)", hjust = 0, vjust = -0.5, size = 3, angle = 90),
waatu_ex_clump + theme(legend.position = "none") + annotate("text", x = ext(sampling_area_waatu)[2], y = ext(sampling_area_waatu)[3], label = "clustered", hjust = 0, vjust = -0.5, size = 3, angle = 90),
nrow = 2, ncol = 6,
widths = c(1, 1, 1),  # Adjust widths for spacing
labels = c("A.", "B.", "C.", "D.", "E.", "F.",
"G.", "H.", "I.", "J.", "K.", "L."),
common.legend = TRUE
)
ex_maps
save_plot(paste0("plots/all_example_sampling_designs.png"), ex_maps, base_width = 10, base_height = 5)
# Define the function for creating the raster plot
create_raster_plot <- function(data, sampling_area, SZ, land, colour_palette) {
bbox <- sf::st_bbox(sampling_area)
# Filter raster data to only include points within the sampling area bounding box
data_subset <- data[data$x >= bbox["xmin"] & data$x <= bbox["xmax"] &
data$y >= bbox["ymin"] & data$y <= bbox["ymax"], ]
# Calculate min and max only from the subset
fill_min <- min(data_subset$p_fish.fit, na.rm = TRUE)
fill_max <- max(data_subset$p_fish.fit, na.rm = TRUE)
ggplot() +
geom_raster(data = data, aes(x = x, y = y, fill = p_fish.fit), interpolate = TRUE) +
geom_sf(data = sampling_area, aes(color = 'Simulation area'),
fill = 'transparent', linewidth = 1, show.legend = FALSE) +
geom_sf(data = SZ, aes(color = 'Simulated NTZ'),
fill = 'transparent', linewidth = 1, show.legend = FALSE) +
scale_color_manual(name = '',
values = c('Simulation area' = "darkgray",
'Simulated NTZ' = colour_palette[2])) +
geom_sf(data = land, color = "darkgray", fill = 'lightgray', size = 0.2) +
custom_theme +
scale_fill_gradient(
name = "",
low = "white", high = colour_palette[4],
limits = c(fill_min, fill_max)  # Use min/max from cropped area
) +
theme(
axis.text.x = element_blank(),
axis.text.y = element_blank(),
axis.ticks = element_blank(),
axis.title.x = element_blank(),
axis.title.y = element_blank(),
legend.position = "none",
plot.margin = margin(0, 0, 0, 0, "cm")
) +
coord_sf(crs = 4326, xlim = ext(sampling_area)[1:2], ylim = ext(sampling_area)[3:4])
}
# WAATERN
study_site <- "waatern"
SZ <- st_read(paste0("QGIS layers/clean/", study_site, "_simulated_SZ.shp")) %>% st_transform(crs=target_crs) # simulated SZ shapefile
pred_PS      <- as.data.frame(terra::project(readRDS(paste0("outputs/distribution_modelling_outputs/D05_SZ_increase_distribution_rasters/D05_", study_site, "_SZ_increase_predicted_abundance_Sparidae_Chrysophrys_auratus.rds")), "EPSG:4326"), xy=TRUE)
pred_SMW     <- as.data.frame(terra::project(readRDS(paste0("outputs/distribution_modelling_outputs/D05_SZ_increase_distribution_rasters/D05_", study_site, "_SZ_increase_predicted_abundance_Labridae_Ophthalmolepis_lineolatus.rds")), "EPSG:4326"), xy=TRUE)
pred_WAD     <- as.data.frame(terra::project(readRDS(paste0("outputs/distribution_modelling_outputs/D05_SZ_increase_distribution_rasters/D05_", study_site, "_SZ_increase_predicted_abundance_Glaucosomatidae_Glaucosoma_hebraicum.rds")), "EPSG:4326"), xy=TRUE)
PS_raster_waatern <- create_raster_plot(pred_PS, sampling_area_waatern, SZ, land, colour_palette)
SMW_raster_waatern <- create_raster_plot(pred_SMW, sampling_area_waatern, SZ, land, colour_palette)
WAD_raster_waatern <- create_raster_plot(pred_WAD, sampling_area_waatern, SZ, land, colour_palette)
# WAATU
study_site <- "waatu"
SZ <- st_read(paste0("QGIS layers/clean/", study_site, "_simulated_SZ.shp")) %>% st_transform(crs=target_crs) # simulated SZ shapefile
pred_PS      <- as.data.frame(terra::project(readRDS(paste0("outputs/distribution_modelling_outputs/D05_SZ_increase_distribution_rasters/D05_", study_site, "_SZ_increase_predicted_abundance_Sparidae_Chrysophrys_auratus.rds")), "EPSG:4326"), xy=TRUE)
pred_SMW     <- as.data.frame(terra::project(readRDS(paste0("outputs/distribution_modelling_outputs/D05_SZ_increase_distribution_rasters/D05_", study_site, "_SZ_increase_predicted_abundance_Labridae_Ophthalmolepis_lineolatus.rds")), "EPSG:4326"), xy=TRUE)
pred_WAD     <- as.data.frame(terra::project(readRDS(paste0("outputs/distribution_modelling_outputs/D05_SZ_increase_distribution_rasters/D05_", study_site, "_SZ_increase_predicted_abundance_Glaucosomatidae_Glaucosoma_hebraicum.rds")), "EPSG:4326"), xy=TRUE)
PS_raster_waatu <- create_raster_plot(pred_PS, sampling_area_waatu, SZ, land, colour_palette)
SMW_raster_waatu <- create_raster_plot(pred_SMW, sampling_area_waatu, SZ, land, colour_palette)
WAD_raster_waatu <- create_raster_plot(pred_WAD, sampling_area_waatu, SZ, land, colour_palette)
# Arrange raster plots (Bottom Row) with individual legends
raster_plots <- ggarrange(
PS_raster_waatern + annotate("text", x = ext(sampling_area_waatern)[1], y = ext(sampling_area_waatern)[4], label = "Yijarup/Pink \nSnapper", hjust = -0.1, vjust = 1.1, size = 3),
SMW_raster_waatern + annotate("text", x = ext(sampling_area_waatern)[1], y = ext(sampling_area_waatern)[4], label = "Southern \nMaori \nWrasse", hjust = -0.1, vjust = 1.1, size = 3),
WAD_raster_waatern + annotate("text", x = ext(sampling_area_waatern)[1], y = ext(sampling_area_waatern)[4], label = "Djubitj/West \nAustralian \nDhufish", hjust = -0.1, vjust = 1.1, size = 3),
PS_raster_waatu + annotate("text", x = ext(sampling_area_waatu)[2], y = ext(sampling_area_waatu)[3], label = "Yijarup/Pink Snapper", hjust = 0, vjust = -0.5, size = 3, angle = 90),
SMW_raster_waatu + annotate("text", x = ext(sampling_area_waatu)[2], y = ext(sampling_area_waatu)[3], label = "Southern Maori Wrasse", hjust = 0, vjust = -0.5, size = 3, angle = 90),
WAD_raster_waatu + annotate("text", x = ext(sampling_area_waatu)[2], y = ext(sampling_area_waatu)[3], label = "Djubitj/West Australian Dhufish", hjust = 0, vjust = -0.5, size = 3, angle = 90),
nrow = 1, widths = c(1, 1, 1),
labels = c("M.", "N.", "O.", "P.", "Q.", "R."),
common.legend = FALSE
)
raster_plots
# make a big combined plot with example SDs + rasters
save_plot("plots/species_prediction_plot.png", raster_plots, base_width = 10, base_height = 2)
# full stitched plot
all_plots <- ggarrange(ex_maps, raster_plots, ncol =1, heights = c(2, 1), align = "hv")
plot(sampling_area_waatu$geometry)
plot(sf_all$geometry)
plot(sf_all)
st_area(sf_all)
st_area(sf_all)/1000000
sf_all
st_area(sf_all %>% group_by(detrended))
area <- sf_all %>%
group_by(detrended)
area
area <- sf_all %>%
group_by(detrended, in_SZ) %>%
st_join()
area <- sf_all %>%
group_by(detrended, in_SZ) %>%
st_union()
area
area <- sf_all %>%
group_by(detrended, in_SZ) %>%
summarize(geometry = st_union(geometry))
area
st_area(area)
area <- sf_all %>%
group_by(detrended, in_SZ) %>%
summarize(geometry = st_union(geometry)) %>%
st_area()
area
area <- sf_all %>%
group_by(detrended, in_SZ) %>%
summarize(geometry = st_union(geometry)) %>%
mutate(area = st_area())
area
area <- sf_all %>%
group_by(detrended, in_SZ) %>%
summarize(geometry = st_union(geometry)) %>%
mutate(area = st_area(geometry))
area <- sf_all %>%
group_by(detrended, in_SZ) %>%
summarize(geometry = st_union(geometry)) %>%
mutate(area = st_area(geometry)) %>%
glimpse()
plot(area)
View(area)
plot(area[area$detrended == 1])
plot(area[area$detrended == 0,])
area <- sf_all %>%
group_by(detrended) %>%
summarize(geometry = st_union(geometry)) %>%
mutate(area = st_area(geometry)) %>%
glimpse()
plot(area[area$detrended == 0,])
sf_all              <- readRDS(paste0("outputs/distribution_modelling_outputs/D04_", study_site, "_sample_area_detrended_strata.rds")) %>% st_transform(crs=target_crs) # detrended bathymetry strata in the simulation area
plot(sf_all)
study_site <- "waatern"
sf_all              <- readRDS(paste0("outputs/distribution_modelling_outputs/D04_", study_site, "_sample_area_detrended_strata.rds")) %>% st_transform(crs=target_crs) # detrended bathymetry strata in the simulation area
plot(sf_all)
area <- sf_all %>%
group_by(detrended) %>%
summarize(geometry = st_union(geometry)) %>%
mutate(area = st_area(geometry)) %>%
glimpse()
area <- sf_all %>%
st_make_valid() %>%
group_by(detrended) %>%
summarize(geometry = st_union(geometry)) %>%
mutate(area = st_area(geometry)) %>%
glimpse()
rm(list=ls())
colour_palette <- readLines("chapter_colours.txt"); colour_palette <- eval(parse(text = colour_palette))
source("custom_theme.R")
library(tidyverse)
library(patchwork)
library(sf)
library(terra)
library(ggpubr)
library(cowplot)
library(imager)
library(grid) # for images
library(magick) # for images
library(gt)
## Figure 1. the study area ---------------------------------------------------
p_mb <- ggplot(mb, aes(x = SD, y = mean_bias, fill = SD)) +
geom_boxplot(position = position_dodge(0.9), outlier.size = 0.5) +
geom_hline(aes(yintercept = 0), linetype = "dashed", color = colour_palette[6], size = 1) +
facet_grid(cols = vars(species_formatted)) +
labs(y = "Mean Bias") +
custom_theme +
theme(
axis.text.x = element_blank(),  # Removes only x-axis text
axis.title.x = element_blank(),  # Removes x-axis title
strip.text.x = element_blank()  # Removes column facet titles (species names
) +
scale_fill_manual(values = gradient_colors) +
scale_color_manual(values = c("white" = colour_palette[6], "black" = "black")) +
coord_cartesian(ylim = c(NA, 1))
species_lookup <- data.frame( # lookup table so that different dataframes recognise the species names
species_formatted = c(
"Yijarup/Pink Snapper",
"Djubitj/West Australian Dhufish",
"Southern Maori Wrasse"
),
species = c(
"Sparidae_Chrysophrys_auratus",
"Glaucosomatidae_Glaucosoma_hebraicum",
"Labridae_Ophthalmolepis_lineolatus"
)
)
study_site <- "waatern"
raw <- readRDS(paste0("outputs/distribution_modelling_outputs/D06_sampling_design_performance/D06_", study_site, "_sampling_design_performance_raw_data.rds"))%>%
left_join(species_lookup, by = "species") %>%
glimpse()
raw$species_formatted <- factor(raw$species_formatted, levels = c("Yijarup/Pink Snapper", "Southern Maori Wrasse", "Djubitj/West Australian Dhufish"))
sig <- readRDS(paste0("outputs/distribution_modelling_outputs/D06_sampling_design_performance/D06_", study_site, "_significance_testing_model_results.rds")) %>%
left_join(species_lookup, by = "species") %>%
dplyr::select(c(SD, design_id, p_value, estimate, species_formatted)) %>%
glimpse()
sig$species_formatted <- factor(sig$species_formatted, levels = c("Yijarup/Pink Snapper", "Southern Maori Wrasse", "Djubitj/West Australian Dhufish"))
mb <- readRDS(paste0("outputs/distribution_modelling_outputs/D06_sampling_design_performance/D06_", study_site, "_sampling_design_performance_mean_bias.rds")) %>%
left_join(species_lookup, by = "species") %>%
glimpse()
mb$species_formatted <- factor(mb$species_formatted, levels = c("Yijarup/Pink Snapper", "Southern Maori Wrasse", "Djubitj/West Australian Dhufish"))
rmse <- readRDS(paste0("outputs/distribution_modelling_outputs/D06_sampling_design_performance/D06_", study_site, "_sampling_design_performance_RMSE.rds")) %>%
left_join(species_lookup, by = "species") %>%
glimpse()
rmse$species_formatted <- factor(rmse$species_formatted, levels = c("Yijarup/Pink Snapper", "Southern Maori Wrasse", "Djubitj/West Australian Dhufish"))
int_cov <- readRDS(paste0("outputs/distribution_modelling_outputs/D06_sampling_design_performance/D06_", study_site, "_sampling_design_performance_interval_coverage.rds")) %>%
left_join(species_lookup, by = "species") %>%
glimpse()
int_cov$species_formatted <- factor(int_cov$species_formatted, levels = c("Yijarup/Pink Snapper", "Southern Maori Wrasse", "Djubitj/West Australian Dhufish"))
realised_ab <- readRDS(paste0("outputs/distribution_modelling_outputs/D06_sampling_design_performance/D06_", study_site, "_sampling_design_performance_realised_abundances.rds"))
realised_long <- realised_ab %>%
dplyr::select(species_raw, #species_formatted = species_formatted.x,
SZ = mean_abundance_inside, fished = mean_abundance_outside) %>%
pivot_longer(cols = c(SZ, fished),
names_to = "status",
values_to = "realised_abundance_mean") %>%
left_join(species_lookup, by = c("species_raw" = "species")) %>%
glimpse()
realised_long$species_formatted <- factor(realised_long$species_formatted, levels = c("Yijarup/Pink Snapper", "Southern Maori Wrasse", "Djubitj/West Australian Dhufish"))
gradient_colors <- colorRampPalette(c(colour_palette[4], colour_palette[6]))(6)
### raw data ------------------------------------------------------------------
p_raw <- ggplot(raw, aes(x = SD, y = obs_ab_mean, fill = status)) +
geom_boxplot(width = 1, color = "black", alpha = 0.5, position = position_dodge(0.9), outlier.size = 0.5) +
# Add horizontal dashed lines for realised abundance
geom_hline(data = realised_long,
aes(yintercept = realised_abundance_mean,
color = status,
group = interaction(species_formatted, status)),
linetype = "dashed",
linewidth = 0.8) +
facet_wrap(~ species_formatted, scales = "free_y") +
custom_theme +
labs(
fill = "Status",
x = "Sampling Design",
y = "Observed\nAbundance"
) +
scale_fill_manual(values = colour_palette[c(6, 1)], labels = c("fished", "NTZ")) +
scale_color_manual(values = colour_palette[c(6, 1)], guide = "none") +  # hide redundant legend
theme(legend.position = "none",
axis.text.x = element_blank(),  # Removes only x-axis text
axis.title.x = element_blank()  # Removes x-axis title
)
### mean bias -----------------------------------------------------------------
p_mb <- ggplot(mb, aes(x = SD, y = mean_bias, fill = SD)) +
geom_boxplot(position = position_dodge(0.9), outlier.size = 0.5) +
geom_hline(aes(yintercept = 0), linetype = "dashed", color = colour_palette[6], size = 1) +
facet_grid(cols = vars(species_formatted)) +
labs(y = "Mean Bias") +
custom_theme +
theme(
axis.text.x = element_blank(),  # Removes only x-axis text
axis.title.x = element_blank(),  # Removes x-axis title
strip.text.x = element_blank()  # Removes column facet titles (species names
) +
scale_fill_manual(values = gradient_colors) +
scale_color_manual(values = c("white" = colour_palette[6], "black" = "black")) +
coord_cartesian(ylim = c(NA, 1))
## rmse -----------------------------------------------------------------------
p_rmse <- ggplot(rmse, aes(x = SD, y = rmse, fill = SD)) +
geom_boxplot(position = position_dodge(0.9), outlier.size = 0.5) +
geom_hline(aes(yintercept = 0), linetype = "dashed", color = colour_palette[6], size = 1) +
facet_grid(cols = vars(species_formatted)) +
labs(y = "RMSE") +
custom_theme +
theme(
axis.text.x = element_blank(),  # Removes only x-axis text
axis.title.x = element_blank(),  # Removes x-axis title
strip.text.x = element_blank()  # Removes column facet titles (species names
) +
scale_fill_manual(values = gradient_colors) +
scale_color_manual(values = c("white" = colour_palette[4], "black" = "black")) +
scale_y_continuous(limits = c(0, NA)) +  # Cut off values below 0 - rmse cannot be negative, but the violin plot makes it look like there are neg values even though there aren't
coord_cartesian(ylim = c(0, 0.75))
## interval coverage ----------------------------------------------------------
p_ic <- ggplot(int_cov, aes(x = SD, y = int_coverage, fill = SD)) +
geom_bar(stat = "identity", position = "dodge", colour = "black") +
facet_wrap(~species) +
labs(y = "Coverage") +
(custom_theme %+replace% theme(
axis.title.x = element_blank(),
strip.text.x = element_blank(),
axis.text.x  = element_text(angle = 90, colour = "#08415C")
)) +
geom_hline(data = int_cov,
aes(yintercept = 0.95), linetype = "dashed", color = colour_palette[6], size = 1) +
scale_fill_manual(values = gradient_colors) +
coord_cartesian(ylim = c(0.5, 1))
## p-value --------------------------------------------------------------------
species_lookup_mod <- species_lookup %>%
mutate(short_species = str_extract(species, "[^_]+_[^_]+$"))
sig <- sig %>%
mutate(SD = recode(SD,
"simple_spabal" = "Si_SB",
"stratified_spabal_2030" = "St_SB_2030",
"stratified_spabal_2525" = "St_SB_2525",
"pref_2030" = "P_2030",
"pref_2525" = "P_2525",
"clustered" = "C"
)) %>%
left_join(species_lookup_mod %>% select(species_formatted, species),
by = "species_formatted")
summary_stats <- sig %>%
group_by(species_formatted, SD) %>%
summarise(
total = n(),
under_0.05 = sum(p_value < 0.05, na.rm = TRUE),
perc_under_0.05 = round(100 * under_0.05 / total, 2)
) %>%
arrange(desc(perc_under_0.05))
p_sig <- ggplot(sig, aes(x = SD, y = p_value)) +
geom_boxplot(outlier.size = 0.5, varwidth = T, aes(fill = SD)) +
facet_wrap(~ species_formatted) +
labs(
title = "",
x = "",
y = "P-value for\nNTZ effect"
) +
custom_theme +
theme(
axis.text.x = element_blank(),  # Removes only x-axis text
axis.title.x = element_blank(),  # Removes x-axis title
strip.text.x = element_blank()  # Removes column facet titles (species names
) +
scale_fill_manual(values = gradient_colors) +
annotate("rect", xmin = -Inf, xmax = Inf, ymin = -0.01, ymax = 0.05, alpha = 0.25, fill = colour_palette[1])
# model estimate --------------------------------------------------------------
test <- realised_ab %>%
mutate(ra = mean_abundance_outside/mean_abundance_inside)
test2 <- sig %>%
glimpse()
lookup <- tibble::tribble(
~species_formatted, ~species_raw,
"Djubitj/West Australian Dhufish", "Glaucosomatidae_Glaucosoma_hebraicum",
"Yijarup/Pink Snapper", "Sparidae_Chrysophrys_auratus",
"Southern Maori Wrasse", "Labridae_Ophthalmolepis_lineolatus"
)
# Join to attach realised abundance
test2 <- test2 %>%
left_join(lookup, by = "species_formatted") %>%
left_join(
realised_ab %>% dplyr::select(species_raw, realised_abundance_ratio),
by = "species_raw"
) %>%
rename(ra = realised_abundance_ratio)
# Plot
p_est <- ggplot(test2, aes(x = SD, y = estimate)) +
geom_boxplot(outlier.shape = NA, varwidth = TRUE, aes(fill = SD)) +
facet_wrap(~ species_formatted) +
geom_hline(aes(yintercept = ra), linetype = "dashed", color = colour_palette[1], size = 1) +
labs(
x = "",
y = "Estimate for\nNTZ effect"
) +
custom_theme +
scale_fill_manual(values = gradient_colors) +
theme(
axis.text.x = element_blank(),  # Removes only x-axis text
axis.title.x = element_blank(),  # Removes x-axis title
strip.text.x = element_blank()  # Removes column facet titles (species names
) +
coord_cartesian(ylim = c(0, 2))
# all plots -------------------------------------------------------------------
if (study_site == "waatu") {
waatu <- (p_raw / p_sig / p_est / p_mb / p_rmse / p_ic) +
plot_layout(heights = rep(1, 6)) +
plot_annotation(
title = '        Waatu/Capes Region',
tag_levels = "A", tag_suffix = "."
) &
theme(plot.margin = margin(rep(0, 4)))  # reduce plot margins for each subplot
}
if (study_site == "waatern") {
waatern <- (p_raw / p_sig / p_est / p_mb / p_rmse / p_ic) +
plot_layout(heights = rep(1, 6)) +
plot_annotation(
title = '        Waatern/Geographe Bay',
tag_levels = "A", tag_suffix = "."
) &
theme(plot.margin = margin(rep(0, 4)))  # reduce plot margins for each subplot
}
detail <- waatu | waatern
