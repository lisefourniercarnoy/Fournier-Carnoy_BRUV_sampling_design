---
title: "Chapter II - Sampling design comparison"
author:
  - name: Lise Fournier-Carnoy
    affiliation: 1
  - name: Claude Spencer
    affiliation: 1
  - name: Ben Radford
    affiliation: 4
  - name: Stan Mastrantonis
    affiliation: 3
  - name: Jordan Goetze
    affiliation: 2
  - name: Matt Navarro
    affiliation: 1
  - name: Tim Langlois
    affiliation: 1
affiliations:
  - id: 1
    name: "Indian Ocean Marine Research Centre, University of Western Australia, Perth, Western Australia"
  - id: 2
    name: "Department of Biodiversity, Conservation and Attractions, Perth, Western Australia"
  - id: 3
    name: "School of Agriculture and Environment, Centre for Water and Spatial Science, University of Western Australia, Perth, Western Australia"
  - id: 4
    name: "Oceans Institute, University of Western Australia, Perth, Western Australia"
date: "`r Sys.Date()`"
output:
  bookdown::html_document2:
    toc: yes
    number_sections: yes
    fig_caption: yes
always_allow_html: true
latex_engine: xelatex
bibliography: references_sampling_design.bib
---

```{r, include = FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

# Introduction

Anthropogenic stressors globally have caused significant declines in biodiversity, abundance and habitats [@Isbell2023; @Pereira2010]. In the marine environment, increases in the loss of essential habitats has lead to the loss of biodiversity and biomass in the marine environment [@Airoldi2008], increased the total area of dead zones, and lead to mass extinctions [@Luypaert2020; @Mccauley2015]. As a result, there has been a push for the creation and expansion of Marine Protected Areas (MPAs) and No-Take-Zones (NTZs) to safeguard biodiversity [@Zhao2024; @Robinson2024]: MPAs could provide resilience to changes driven by climate change in the medium-term by managing local stressors [@Ling2012; @Brown2013; @Gissi2021]. However, to better understand how MPAs affect species, habitats and ecosystems, and how they interact with local and global stressors, accurate monitoring is needed over adequate spatial and temporal scales [@Borja2021]. Correctly identifying the benefits of MPAs (or lack thereof) is therefore also critical to advise whether objectives are being met and ecosystems are adequately protected from local stressors [@Miller2014].

Many methods are used to monitor MPAs, depending on the biodiversity within them, the threats facing it, and the priorities identified by researchers [@Simpson2015]. The experimental designs used in monitoring have long been discussed, to ensure biological trends detected in the monitoring data are correctly attributed to the conservation intervention under study: @Miteva2012 review conservation instruments (including protected areas) and urge the need for better data to evaluate conservation interventions, to avoid drawing the wrong conclusions from monitoring data. In the past, studies assessing MPA effectiveness lacked controls and spatial/temporal replicates [@Underwood1991; @Osenberg2006], which limited the power of monitoring data. Improving experimental designs when monitoring MPAs will increase our ability to detect change and assess the effect and performance of MPAs on biological metrics [@Hayes2019].

Spatial sampling design can result in large differences in estimates and outcomes depending on the sampling method used. For stock assessments of fished species [@Liu2009; @Cheng2024] and underwater visual census of reef fish [@Bryan2016; @Smith2011], discussions as to how to distribute samples across a study area are common. Sample site choice can be separated into four broad categories: Systematic, Random, Preferential or Spatially Stratified. Systematic sampling effectively captures all scales (temporal or spatial) of a process, providing the most accurate estimates, [@Cheng2024] although labour-intensive and rarely feasible in most contexts. Preferential sampling, a stochastically dependent method (i.e. selective site choice, Cecconi et al., 2016), greatly reduces costs while focusing on the process of interest. However, depending on the aim of sampling, the effect of selective bias on estimates may be significant, especially abundance [@Aubry2024; @Conn2017], which is why Randomised sampling has been prevalent in research as a simple alternative. Stratified Random Sampling (referred hereafter as 'spatially balanced') seeks to randomly select sites equally between strata (shallow, mid-depth, deep, or seagrass, sand, reef habitats, for example) in an effort to obtain accurate relative abundance estimates for species of interest [@Cheng2024], potentially improving on Preferential designs [@Conn2017], while capturing a more representative population structure or community [@Bryan2016] compared to Random sampling. Studies comparing sampling designs often operate at large spatial scales (100s of km, @Cheng2024, @Switzer2023), investigating large biological processes like regional species abundance for fisheries stock assessments. At smaller spatial scales, sampling design is less studied: @Bryan2016 found that obtaining precise estimates for inside/outside management zones like MPAs would require more samples rather than larger scales of study for stratified sampling, but few comparisons of sampling designs for the detection of MPA effects specifically exists. Similarly, very little work comparing BRUV performance using different sampling designs exists.

In Australia, Baited Remote Underwater Video (BRUVs) are widely used to monitor the effects of marine management like Marine Parks (MPAs) on abundance and size of communities and target species [@Harasti2018; @Kelaher2014; @Malcolm2018]. BRUVs present advantages compared to other common methods, including the ability to sample areas inaccessible by divers and more sensitive detection of changes in fish communities compared to other census methods [@Schramm2020]. The ability to use footage for a variety of research questions, including fish community, [@Watson2007] size, [@Malcolm2018; @Watson2009] and habitat [@Scott2022] make BRUVs a popular choice for researchers. Like any spatial sampling, the choice of where to deploy sampling units like BRUVs depends on the research question of interest [@Foster2018], yet very few comparisons of BRUV spatial sampling designs exist to guide researchers.

In south-west Western Australia, recreational fishing pressure has lead to the depletion of emblematic fish species like Djubitj/West Australia Dhufish (*Glaucosoma hebraicum*) and Yijarup/Pink Snapper (*Chrysophrys auratus*) [@Ryan2022; @Gaynor2008]. To protect species and habitats from destructive and extractive activities, the Ngari Capes Marine Park (in Wadandi Country, between Waatern/Geographe Bay and Taalinup/Augusta) includes a network of highly protected areas ('Sanctuary Zones'), expected to provide conservation benefits to certain fish species which experience significant pressure like Yijarup/Pink Snapper (as has been found in other similar highly protected areas: @Alos2013; @Taylor2010; @Harasti2018; @Harasti2019). This Marine Park is part of a state-wide network of Marine Parks following CAR principles (comprehensive, adequate, representative) of biodiversity conservation. The area is monitored by BRUVs, inside and outside NTZs, with two different spatial sampling designs aiming to assess MPA performance and effectiveness (preferential and spatially balanced). This context represents a perfect case study for the comparison of these two sampling designs to assess fish communities in NTZs.

This preliminary study aims to compare two BRUV spatial sampling designs at a local (\<30km) scale, to understand how the detection of single and multiple species differ between a preferential and spatially balanced sampling design in and near a NTZ. Real BRUV data is used to (1.) compare community composition, and (2.) simulate sampling designs on a modelled spatial distribution model of a single species. Yijarup/Pink Snapper (*Chrysophrys auratus*) was chosen as a study species for (2.) as it is both a popular recreational fishing species [@Ryan2022; @Gaynor2008] as well as a species of interest to Wadandi Traditional Owners, who have intimate traditional knowledge of this species' ecology and life history, cited in Wadandi cultural songlines [@Davies2022].

# Methods

```{r read-data, include = FALSE}
rm(list=ls())

library(rticles)
library(sf)
library(raster)
library(ggplot2)
library(terra)
library(knitr)
library(ggpubr)
library(ggplot2)
library(grid)
library(gridExtra)
library(tidyverse)
library(kableExtra)


```

## Study site and BRUV deployment

```{r real_BRUV_location_prep, include = FALSE, echo = FALSE, message = FALSE, warning = FALSE}

aus             <- st_read("data/spatial/shapefiles/wadandi_land.shp") # land shapefile
com_samp_area <- st_read("QGIS layers/polys/com_comp_analysis_limits.shp")
AMP <- st_read("QGIS layers/polys/AMP_local.shp") # real SZs
MPA <- st_read("QGIS layers/polys/swc_sanctuaryzones.shp"); MPA <- st_zm(MPA); st_crs(MPA) <- 4326 # real SZs

pref            <- st_read("QGIS layers/2024_pref_BRUVs.shp") # real BRUV state points
spabal          <- st_read("QGIS layers/2024_spabal_BRUVs.shp") # real BRUV commonwealth points
MaxN            <- read.csv("data/tidy/2024_geographe_all_tidy_maxn.csv") # all MaxNs

```

```{r real_BRUV_location, echo = FALSE, fig.cap= "(A.) Wadandi Ranger Joe Burgess deploying a BRUV in Waatern/Geographe Bay. (B.) Yijarup/Pink Snapper (*C. auratus*), Eagle Ray (*M. tenuicaudatus*), Southern Maori Wrasse (*C. auricularis*), Skippy (*Pseudocaranx spp*) and Footballer Sweep (*N. obliiquus*) interested in BRUV bait. (C.) Location of preferential and spatially balanced samples in Waatern/Geographe Bay, with the NTZs and boundary of the community composition analysis. (D.) Community Composition analysis limits.", echo = FALSE, message = FALSE, warning = FALSE}

library(ggpubr) # for ggarrange
library(grid)
library(imager)
library(ggspatial) # for scale bars

# Load images as raster grobs
image1 <- rasterGrob(load.image("photos/wadandi_ranger_BRUV.JPG"), interpolate = TRUE)
image2 <- rasterGrob(load.image("photos/BRUV_photo_yijarup_skippy.PNG"), interpolate = TRUE)

# Arrange images into ggplot objects
image_plot1 <- ggplot() + annotation_custom(image1) + theme_void()
image_plot2 <- ggplot() + annotation_custom(image2) + theme_void() 

plot <- ggplot() +
  geom_sf(data = aus, fill = "lightgrey", color = "darkgray", size = 0.2) +
  geom_sf(data = com_samp_area,
          aes(fill = 'Community \ncomposition \nanalysis limits'), color = "#f1c232", size = 5) +
  geom_sf(data = AMP[AMP$ZoneName == 'National Park Zone',],
          aes(fill = 'No-take \nzones'), color = "#ffd966", size = 0.5) +
  geom_sf(data = MPA,
          aes(fill = 'No-take \nzones'), color = "#ffd966", size = 0.2) +
  geom_sf(data = pref[pref$longitude > 115.3,],
          aes(color = 'Preferential \nsampling'), size = 1, shape = 16) +
  geom_sf(data = spabal[spabal$SD == 'spabal',],
          aes(color = 'Spatially \nbalanced \nsampling'), size = 1, shape = 16) +
  geom_sf(data = spabal[spabal$SD == 'pref',],
          aes(color = 'Preferential \nsampling'), size = 1, shape = 16) +
  coord_sf(crs = 4326, xlim = ext(spabal)[1:2], ylim = ext(spabal)[3:4]) +
  theme_minimal() +
  scale_fill_manual(values = c('No-take \nzones' = "#fff2cc", 'Community \ncomposition \nanalysis limits' = 'transparent')) +
  scale_color_manual(values = c('Preferential \nsampling' = "#f1c232", 'Spatially \nbalanced \nsampling' = "#7f6000")) +
  labs(fill = '', color = '') +
  theme(legend.position = "bottom",
        legend.box = "horizontal",
        legend.box.spacing = unit(0, "cm"),
        legend.key.size = unit(0.5, "cm"),
        legend.text = element_text(size = 10)) +
  annotation_scale(location = "br", width_hint = 0.2)  # Adds a scale bar

plot_zoom <- ggplot() + # zoomed in
  geom_sf(data = aus, fill = "lightgrey", color = "darkgray", size = 0.2) +
  geom_sf(data = com_samp_area,
          aes(fill = 'Community \ncomposition \nanalysis limits'), color = "#f1c232", size = 5) +
  geom_sf(data = AMP[AMP$ZoneName == 'National Park Zone',],
          aes(fill = 'No-take \nzones'), color = "#ffd966", size = 0.5) +
  geom_sf(data = MPA,
          aes(fill = 'No-take \nzones'), color = "#ffd966", size = 0.2) +
  geom_sf(data = pref[pref$longitude > 115.3,],
          aes(color = 'Preferential \nsampling'), size = 1, shape = 16) +
  geom_sf(data = spabal[spabal$SD == 'spabal',],
          aes(color = 'Spatially \nbalanced \nsampling'), size = 1, shape = 16) +
  geom_sf(data = spabal[spabal$SD == 'pref',],
          aes(color = 'Preferential \nsampling'), size = 1, shape = 16) +
  coord_sf(crs = 4326, xlim = ext(com_samp_area)[1:2], ylim = ext(com_samp_area)[3:4]) +
  theme_minimal() +
  scale_fill_manual(values = c('No-take \nzones' = "#fff2cc", 'Community \ncomposition \nanalysis limits' = 'transparent')) +
  scale_color_manual(values = c('Preferential \nsampling' = "#f1c232", 'Spatially \nbalanced \nsampling' = "#7f6000")) +
  labs(fill = '', color = '') +
  theme(legend.position = "bottom",
        legend.box = "horizontal",
        legend.box.spacing = unit(0, "cm"),
        legend.key.size = unit(0.5, "cm"),
        legend.text = element_text(size = 10),
        axis.text.x = element_blank(),  # Remove x-axis 
        axis.text.y = element_blank()   # Remove y-axis 
  ) +
  annotation_scale(location = "br", width_hint = 0.2)  # Adds a scale bar

# Combine the two plots with a shared legend
combined_plots <- ggarrange(
  plot, plot_zoom,
  ncol = 2,
  common.legend = TRUE,
  legend = "bottom",
 labels = c("C", "D"),
 widths = c(1.45, 1)  # Equal heights for both plots
  )

# Arrange everything
final_layout <- ggarrange(
  ggarrange(image_plot1, 
            image_plot2, 
            ncol = 2, 
            labels = c("A", "B"),
            widths = c(1, 1)),
  combined_plots,
  nrow = 2, 
  heights = c(1, 1.6)
)

# Display the final layout
final_layout

```

Waatern/Geographe Bay is a shallow sandy bay in Wadandi Country, \~250km south of Perth, in south-west Western Australia. (Figure \@ref(fig:real_BRUV_location)) It represents a temperate ecosystem dominated by seagrass beds, sand and limestone reef [@Galaiduk2018]. The area contains three Sanctuary Zones (SZs) gazetted in 2018, covering 51.77km^2^ of the bay. Fishing is excluded within the SZs.

Stereo Baited Remote Underwater Video (BRUV) footage was collected February-April 2024 as part of the state and federal Marine Park monitoring of Western Australia (Table \@ref(tab:n_samples_table)). Deployments were conducted following standardised protocols for bait quantity and deployment times, used across Australia, which include calibration of the stereo systems before and after campaigns [@Langlois2020]. Wadandi Rangers and Cultural Custodian Elders were present and participated in the entirety of the BRUV deployments, informing the location of some of the preferential deployments. (Figure \@ref(fig:real_BRUV_location))

```{r n_samples_table_prep, include = FALSE, echo = FALSE, message = FALSE, warning = FALSE}

library(tidyverse)

MaxN            <- read.csv("data/tidy/2024_geographe_all_tidy_maxn.csv") %>% glimpse() # all MaxNs
com_comp_maxn   <- readRDS('data/rmd/com_comp_maxn.rds') %>% glimpse()
pref            <- readRDS('data/rmd/samples_sf_pref.rds') %>% glimpse()
spabal          <- readRDS('data/rmd/samples_sf_sb.rds') %>% glimpse()

real_bruv_metadata <- read.csv("data/tidy/2024_geographe_all_tidy_maxn.csv") %>%
  dplyr::select(opcode, status, sd) %>% 
  mutate(subset = ifelse(opcode %in% com_comp_maxn$opcode, TRUE, FALSE),
         full = TRUE) %>% 
    distinct(opcode, .keep_all = TRUE) %>%
  glimpse() # all MaxNs


# 1. Summarize Real BRUVs Collected
# Create summary table


full_summary <- real_bruv_metadata %>%
  group_by(sd) %>%
  summarize(
    `Inside No-Take Area` = sum(if_else(status == "No-take", 1, 0, missing = 0)),
    `Outside No-Take Area` = sum(if_else(status == "Fished", 1, 0, missing = 0)),
    .groups = "drop"
  ) %>%
  mutate(
    subset = NA,  # Placeholder to distinguish this as "full" summary
    Total = `Inside No-Take Area` + `Outside No-Take Area`,
  ) %>%
  glimpse()

# Calculate metrics for subset only
subset_summary <- real_bruv_metadata %>%
  filter(subset == TRUE) %>%  # Consider only rows where subset = TRUE
  group_by(sd, subset) %>%
  summarize(
    `Inside No-Take Area` = sum(if_else(status == "No-take", 1, 0)),
    `Outside No-Take Area` = sum(if_else(status == "Fished", 1, 0)),
    .groups = "drop"
  ) %>%
  mutate(
    full = NA,  # Placeholder to distinguish this as "subset" summary
    Total = `Inside No-Take Area` + `Outside No-Take Area`,
    Row_Title = case_when(
      sd == "preferential" ~ "Preferential Sampling",
      sd == "spatially balanced" & subset == TRUE ~ "Spatially Balanced Sampling (Subset Dataset)",
      TRUE ~ "Unknown"  # Catch-all for unexpected cases
    )) %>% 
  glimpse()

# Combine the results
real_bruvs <- bind_rows(full_summary, subset_summary) %>%
  mutate(
    Row_Title = case_when(
      sd == "preferential" ~ "Preferential Sampling",
      sd == "spatially balanced" & is.na(subset) ~ "Spatially Balanced Sampling (full data)",
      sd == "spatially balanced" & subset==TRUE ~ "Spatially Balanced Sampling (subset data)",
      TRUE ~ "Unknown"
    ),
    Category = "Real BRUVs collected"
  ) %>%
  distinct(Row_Title, .keep_all = TRUE) %>%  # Ensure no duplicates
  dplyr::select(Category, Row_Title, `Inside No-Take Area`, `Outside No-Take Area`, Total) %>%
  glimpse()


# 2. Simulated BRUVs (Spatially Balanced Sampling Design)
simulated_bruvs_balanced <- spabal %>%
  mutate(
    in_SZ = str_detect(zone_strata, "SZ"),  # Identify if it's in the no-take zone
    Strata = case_when(
      str_detect(zone_strata, "strata_1") ~ "Strata 1 (0-50% quantile)",
      str_detect(zone_strata, "strata_2") ~ "Strata 2 (50-80% quantile)",
      str_detect(zone_strata, "strata_3") ~ "Strata 3 (80-100% quantile)",
      TRUE ~ "Unknown Strata"
    )
  ) %>%
  group_by(Strata) %>%  
  summarize(
    `Inside No-Take Area` = sum(in_SZ),               # Sum all points inside the no-take area
    `Outside No-Take Area` = sum(!in_SZ),             # Sum all points outside the no-take area
    Total = n(),                                      # Total count of points
    Row_Title = unique(Strata),
    .groups = "drop"
  ) %>%
  mutate(Category = "Simulated BRUVs (spatially balanced sampling design)") %>%
  dplyr::select(Category, Row_Title, `Inside No-Take Area`, `Outside No-Take Area`, Total) %>% 
  st_drop_geometry() %>% 
  glimpse()



# 3. Simulated BRUVs (Preferential Sampling Design)
simulated_bruvs_preferential <- pref %>%
  mutate(Strata = "Strata 3 (80-100% quantile)", # Assign the single strata label
         in_SZ = str_detect(zone_strata, "SZ")) %>% # Identify if it's in the no-take zone
  group_by(Strata, in_SZ) %>%  # Group by Strata and SZ status
  summarize(n = n(), .groups = "drop") %>%  # Aggregate the counts
  pivot_wider(names_from = in_SZ, values_from = n, values_fill = 0) %>%  # Reshape the data
  summarize(  # Summarize to combine SZ and non-SZ totals
    Category = "Simulated BRUVs (preferential sampling design)",
    Row_Title = unique(Strata),
    `Inside No-Take Area` = sum(`TRUE`),
    `Outside No-Take Area` = sum(`FALSE`),
    Total = `Inside No-Take Area` + `Outside No-Take Area`
  ) %>%
  st_drop_geometry() %>%
  glimpse()

# Combine Data Frames
final_table <- bind_rows(
  real_bruvs,
  simulated_bruvs_balanced,
  simulated_bruvs_preferential
  ) %>%
  arrange(Row_Title) %>%  # Arrange by the specified order
  glimpse()

```

```{r n_samples_table, tab.cap = "Summary of the number of samples inside and outside NTZs a. in real BRUVs (subset data refers to the community composition box around the East Geographe NTZ), b. in simulated spatially balanced BRUVs and c. in simulated preferential BRUVs"}
library(kableExtra)

final_table %>%
  dplyr::select(-Category) %>%  # Remove the 'Category' column
  rename(` ` = Row_Title) %>%  # Replace 'Row_Title' with an empty string
  kbl(caption = "BRUV Sampling Results", format = "html", escape = FALSE) %>%  # Allow HTML rendering
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = F) %>%
  group_rows("a. Real BRUVs collected", 1, 3) %>%
  group_rows("b. Simulated BRUVs (spatially balanced sampling design)", 4, 6) %>%
  group_rows("c. Simulated BRUVs (preferential sampling design)", 7, 7)
```

BRUVs were deployed according to two sampling designs: preferential sampling and spatially balanced sampling:

-   Spatially balanced sampling aims to distribute sampling units randomly within strata of an environmental variable. This sampling design accounts for spatial heterogeneity and spatial autocorrelation [@Kermorvant2019]. More details on this sampling design is available further in section \@ref(sec:SD_sim).

-   Preferential sampling locations were sought out for the seabed complexity of the area, aiming to deploy BRUVs near highly complex sections, where many species tend to aggregate [@Fernandez2008]. Deployments were either clustered around or aligned along seabed features (Figure \@ref(fig:real_BRUV_location).

## Data analysis

### BRUV footage annotation

BRUV footage was annotated by research assistants trained in temperate Australian bony and cartilaginous fish species identification, to obtain MaxN (the greatest number of individuals of a species observed at one time in a deployment), lengths of individuals (possible through the stereo-video system), as well as habitat data [@Langlois2020]. Quality assurance was conducted through species identification cross-checking with other annotators, as well as through CheckEM (<https://github.com/GlobalArchiveManual/CheckEM>), a purpose-built application to compare identified species with their life histories and geographical ranges.

### Effect of sampling design on the detection of community composition differences around a NTZ

The East Geographe NTZ (composed of National Park Zones and Sanctuary Zones) was used as a case study to assess whether the effect of marine protection on community composition was detected differently between sampling designs. This NTZ was the only area of the campaign where the inside and outside of the NTZ were sampled by both sampling designs. Spatially Balanced sample points were subsampled (Figure \@ref(fig:real_BRUV_location)) to match the Preferential sampling in and around the East Geographe NTZ for this part of the analysis. To investigate the difference in species composition between sampling designs, we conducted Principal Coordinate Analysis (PCoA; Bray-Curtis distances; vegan package, @Oksanen2013) and manyglm (negative binomial, adjusted p-values, mvabund package, @Wang2012), a generalised linear model framework for multivariate abundance data. Sampling design (preferential or spatially balanced) and status (NTZ or fished) were included in the model, to account for their potential effects on community composition [@Scott2022; @Watson2007]. Habitat and depth were purposefully not included in the model as we considered them to be a sampling design choice: Bathymetry plays a major role in sampling design choice (see 2.2.3.3 below), and is also a strong contributor to habitat type and species distribution [@Cameron2014]. Assumptions of log-linearity, homoscedasticity and normality were confirmed prior to analysis using the plot.manyglm and qqnorm functions.

### Effect of sampling design on the detection of the NTZ effect of a single species

To compare the sampling designs’ ability to detect the effect of a NTZ on a single species, we conducted simulations of sampling designs on a modelled abundance distribution of Yijarup/Pink Snapper (*C. auratus*) around a simulated NTZ.

#### Abundance distribution model

To build the abundance distribution model, BRUV abundance data was used with several environmental variables obtained from observed and external data (Figure \@ref(fig:distribution_model_diagram)):

To account for seabed morphology, 250m and 5m resolution bathymetry datasets from Geoscience Australia were tested as covariates in the spatial distribution model. The terrain function of the raster package [@Hijmans2015] also allowed bathymetry derivatives (aspect and roughness for both datasets and detrended bathymetry for the 250m dataset) to be tested in the model. Both resolutions were included to test the potential different biological scales that may affect Yijarup/Pink Snapper abundance. Habitat information from BRUV data was used to fit the spatial distribution model. Reef, seagrass and sand were tested, as Yijarup/Pink Snapper abundance has been found to be higher near structured habitat like reef and kelp [@Parsons2016; @Terres2015].

The distribution of Yijarup/Pink Snapper was then modelled using BRUV abundance data (all samples were included, preferential and spatially balanced). Only mature individuals (\>375mm, [@Wakefield2015] were used in models, as these larger fish tend to benefit from NTZ protection [@Alos2013; @Taylor2010]. Obtaining the lengths of fish in a video is dependent on whether the fish are visible and positioned correctly in the video frame, which may not be possible, and we acknowledge that the number of measured mature individuals may not reflect a. the MaxN in that particular video or b. their abundance in the area. Generalised Additive Models (using the FSSgam package in R, @FSSgam) were fitted to BRUV abundance data, using the habitat and bathymetry layers described above as covariates. The relative importance of variables was assessed using the generate.model.set function to select the optimal model by ranking viable model sets according to Akaike Information Criterion (AIC) values [@Fisher2018].

While bathymetry variables were already rasterised, no raster of habitat was deemed accurate or consistent enough to use for this distribution prediction. We therefore fitted Generalised Additive Models (using the FSSgam package in R, @FSSgam) of seagrass, sand and reef habitats (the predominent habitat types in Waatern/Geographe Bay) from BRUV data to the bathymetry and bathymetry derivatives described above to create layers of predicted habitat to use in the Yijarup/Pink Snapper distribution prediction.

From this model, the distribution of Yijarup/Pink Snapper was predicted over the entirety of Waatern/Geographe Bay using the optimal model, and the predict.gam function of the mgcv package in R [@Wood2001]. Predictions were made within the range of observed environmental variables, to avoid extrapolating abundance values.

```{r distribution_model_diagram, fig.cap = "Diagram of the species distribution model process"}

library(imager)
diagram <- ggplot() + annotation_custom(rasterGrob(load.image("photos/population_model_diagram.PNG"), interpolate = TRUE)) + theme_void()
diagram

```

#### Simulated NTZ

To test the ability of each sampling design to detect a true increase in Yijarup/Pink Snapper abundance in NTZs, a simulated NTZ was designed in Waatern/Geographe Bay (Fig. \@ref(fig:example_sampling_design)). The location and size of the NTZ was chosen to be representative and realistic compared to existing NTZs in the area. The chosen area encompasses a reef feature along the coastline, which is protected by the East Geographe NTZs further southwest of the bay.

The mean and standard errors of the predicted Yijarup/Pink Snapper abundance were increased uniformly by 80% within the NTZ to simulate a moderate ‘MPA effect’ on this recreational target species, as had been found for Yijarup/Pink Snapper by @Harasti2018.

#### Sampling design simulation

The sampling design simulations were conducted in an area covering 223.5 km^2^, including \~86.1 km^2^ of NTZ and \~68.7 km^2^ on either side of the simulated NTZ. This aims to mimic the subsample of BRUVs analysed for community composition. Areas shallower than 7m were excluded, as these are rarely targeted in real BRUV campaigns. Two sampling designs were simulated to emulate real BRUV sampling conducted in Waatern/Geographe Bay:

##### a. Spatially Balanced Sampling Design

The spatially balanced sampling design was created by categorising the 250m detrended bathymetry raster layer into 3 strata (based on quantiles values, (\@ref(tab:n_sample_table)), then randomly distributing a set number of sample points into each stratum. The number of sample points were decided to approach the number of samples collected in 2024 in a comparable area (\@ref(tab:n_sample_table)). Sample points were placed using the Generalised Random Tessellation Stratified (GRTS) sampling function from the spsurvey package in R [@Dumelle2023]. The minimum distance between points was set to 500m to reduce spatial autocorrelation. Detrended bathymetry was considered to be most appropriate to use for the stratification as it encompassed the study site’s seabed features better than bathymetry, aspect or roughness. The GRTS sampling function was iterated 1000 times to obtain a set of simulated spatially balanced sampling designs.

##### b. Preferential Sampling Design

Samples were randomly distributed on the highest quantile of detrended bathymetry (Strata 3, Table \@ref(n_samples_table)), to mimic the preferential approach of real sampling. The number of samples per strata were decided based on the number of samples from a comparable area in the BRUV campaign of this paper (Table \@ref(n_samples_table)). The number of samples were then distributed using Generalised Random Tessellation Stratified (GRTS) sampling function from the spsurvey package in R [@Dumelle2023]. This method was iterated 1000 times to obtain a set of simulated preferential sampling designs.

```{r example_sampling_design_prep, include = FALSE, echo = FALSE, message = FALSE, warning = FALSE}
library(tidyverse)
library(sf)
library(raster)
library(terra)

# Load layers
target_crs <- 4326

aus             <- st_read("data/spatial/shapefiles/wadandi_land.shp") %>% st_transform(crs=target_crs) # land shapefile
SZ              <- st_read("data/spatial/shapefiles/simulated_SZ.shp") %>% st_transform(crs=target_crs) # simulated SZ shapefile
sampling_area   <- readRDS("data/spatial/shapefiles/sampling_area_deeper_than_7m.rds") %>% st_transform(crs=target_crs) # simulation area

sf_all          <- readRDS('data/rmd/samp_area_detrended.rds') %>% st_transform(crs=target_crs) # detrended bathymetry strata in the simulation area
samples_sf_pref <- readRDS('data/rmd/samples_sf_pref.rds') %>% st_transform(crs=target_crs) # example points for simulated preferential design
samples_sf_sb   <- readRDS('data/rmd/samples_sf_sb.rds') %>% st_transform(crs=target_crs) # example points for simulated spatially balanced design

mature_pred <- as.data.frame(readRDS("outputs/Length_comparison/predicted_abundance_rasters/mature_predicted_abundance_SZ_increase.rds"), xy=TRUE)
```

```{r example_sampling_design, fig.cap = 'Examples of a. Spatially balanced sampling design simulation and b. Preferential sampling design simulation around the simulated NTZ. C. Predicted abundance around the simulation area with 80% increase in C. auratus within the simulated NTZ.', echo = FALSE, message = FALSE, warning = FALSE}
library(tidyverse); library(sf); library(ggpubr); library(raster); library(terra)

p1 <- ggarrange(
  ggplot() +
    geom_sf(data = sf_all, aes(fill = as.factor(detrended)), colour = NA) +
    scale_fill_manual(values = c("0" = "#F5F5F5", "1" = "#E0E0E0", "2" = "#9E9E9E"),
                      na.value = NA,
                      labels = c("0" = "Strata 1 - low",
                                 "1" = "Strata 2 - medium",
                                 "2" = "Strata 3 - high")) +
    labs(fill = "Detrended bathymetry",
         title = "a.") +
    geom_sf(data = SZ, colour = "#7f6000", fill = NA, linewidth = 1) +
    geom_sf(data = aus, color = "darkgray", fill = 'lightgray',  size = 0.2) +
    geom_sf(data = samples_sf_sb, aes(colour = "Simulated sample points")) +
    coord_sf(crs = 4326, xlim = ext(sampling_area)[1:2], ylim = ext(sampling_area)[3:4]) +
    scale_color_manual(name = '', values = c('Simulated sample points' = 'red')) +
    theme_minimal() +
    theme(axis.text = element_blank(),
          axis.ticks = element_blank()),

  ggplot() +
    geom_sf(data = sf_all, aes(fill = as.factor(detrended)), colour = NA) +
    scale_fill_manual(values = c("0" = "#F5F5F5", "1" = "#E0E0E0", "2" = "#9E9E9E"),
                      na.value = NA,
                      labels = c("0" = "Strata 1 - low",
                                 "1" = "Strata 2 - medium",
                                 "2" = "Strata 3 - high")) +
    labs(fill = "Detrended bathymetry",
         title = "b.") +
    geom_sf(data = SZ, aes(colour = "Simulated SZ"), fill = NA, linewidth = 1) +
    geom_sf(data = aus, color = "darkgray", fill = 'lightgray',  size = 0.2) +
    geom_sf(data = samples_sf_pref, aes(colour = "Simulated sample points")) +
    coord_sf(crs = 4326, xlim = ext(sampling_area)[1:2], ylim = ext(sampling_area)[3:4]) +
    scale_color_manual(name = '', values = c('Simulated sample points' = 'red', 'Simulated SZ'= "#7f6000")) +
    theme_minimal() +
    theme(axis.text = element_blank(),
          axis.ticks = element_blank()),
  ncol = 2, nrow = 1, common.legend = TRUE, legend = "right"
)

p2 <- ggplot() +
  geom_raster(data = mature_pred, aes(x = x, y = y, fill = p_mature.fit), interpolate = TRUE) +
  geom_sf(data = sampling_area, aes(color = 'Simulation area'),
          fill = 'transparent', linewidth = 1) +
  geom_sf(data = SZ, aes(color = 'Simulated NTZ'),
          fill = 'transparent', linewidth = 1) +
  scale_color_manual(name = '',
                     values = c('Simulation area' = '#f1c232', 'Simulated NTZ' = '#7f6000')) +
  geom_sf(data = aus, color = "darkgray", fill = 'lightgray',  size = 0.2) +
  scale_fill_gradient(name = 'Predicted Abundance',
                      limits = c(0, 50),
                      low = "#fff2cc", high = "#7f6000", na.value=NA) +
  labs(title = "c.") +
  theme_minimal() +
  theme(axis.text = element_blank(),
        axis.ticks = element_blank(),
        axis.title.x = element_blank(),
        axis.title.y = element_blank()) + 
    coord_sf(
    xlim = c(st_bbox(sampling_area)["xmin"], st_bbox(sampling_area)["xmax"]),
    ylim = c(st_bbox(sampling_area)["ymin"], st_bbox(sampling_area)["ymax"]),
    expand = FALSE
  )

ggarrange(p1, p2, nrow=2)
```

#### Analysis of simulation

Values of abundance were obtained from the latitude and longitude of the `r final_table$Total[final_table$Category == "Simulated BRUVs (preferential sampling design)"]` simulated points of each of the 2000 simulations. To account for the biological variability of Yijarup/Pink Snapper, and the uncertainty associated with detecting *x* individuals consistently where *x* individuals are predicted to be, each sampling point could observe one abundance value within the Normal distribution of abundance of that raster pixel (rnorm function in base R). For each sampling design, two comparisons were made:

-   Control-Impact (CI) comparison: The ratio of the mean abundance of Yijarup/Pink Snapper inside and outside the simulated NTZ after the abundance increase. This replicates a common monitoring strategy where the effect of the MPA is assessed by comparing the metric of interest in the MPA site (Impact) to that of a similar non-protected site (Control). (Equation 1) [@Underwood1991]

$$
R_{\text{CI}} = \frac{\mu_{\text{NTZ, after}}}{\mu_{\text{fished}}} \tag{1}
$$ - Before-After-Control-Impact (BACI) comparison: The difference of the ratios of the mean abundance of Yijarup/Pink Snapper inside and outside the simulated NTZ, before and after the abundance increase. This replicates the monitoring strategy outlined by @Underwood1991, where the impact of an MPA can be better described by using NTZ sites (Impact) and unprotected sites (Control), over time (Equation 2).

$$
R_{\text{BACI}} = \frac{\mu_{\text{NTZ, after}} - \mu_{\text{NTZ, before}}}{\mu_{\text{fished}}} \tag{2}
$$

# Results

A total of `r final_table$Total[final_table$Row_Title == "Preferential Sampling"] + final_table$Total[final_table$Row_Title == "Spatially Balanced Sampling (full data)"]` BRUV samples were collected, including `r final_table$Total[final_table$Row_Title == "Preferential Sampling"]` preferential and `r final_table$Total[final_table$Row_Title == "Spatially Balanced Sampling (full data)"]` spatially balanced samples (Table \@ref(tab:n_samples_table)). A total of `r length(unique(MaxN$fullspp))` species were detected in samples, including `r length(grep("spp|sp1|sp2|unknown|sp", unique(MaxN$fullspp), ignore.case = TRUE))` species identified to the Genus or Family level and `r length(unique(MaxN$fullspp)) - length(grep("spp|sp1|sp2|unknown|sp", unique(MaxN$fullspp), ignore.case = TRUE))` species identified to the species level. Certain species with very similar appearance (=difficult to identify/differentiate with certainty) were grouped together to form a complex, and are considered as one species.

Within the yellow box specified in Fig. \@ref(fig:example_sampling_design), `r final_table[[3]][final_table$Row_Title == "Preferential Sampling"]` preferential samples were collected inside the NTZ, and `r final_table[[4]][final_table$Row_Title == "Preferential Sampling"]` were collected outside. In the same area, `r final_table[[3]][final_table$Row_Title == "Spatially Balanced Sampling (subset data)"]` spatially balanced samples were collected inside the NTZ, and `r final_table[[4]][final_table$Row_Title == "Spatially Balanced Sampling (subset data)"]` were collected outside the NTZ.

## Effect of sampling design on the detection of community composition differences around a NTZ

```{r manyglm_table_prep, include = FALSE}
library(tidyverse)
library(gt)
library(stringr)

manyglm_output <- readLines("outputs/Community_comparison/manyglm_result.txt")
summary(manyglm_output)

start_multivariate <- grep("Multivariate test", manyglm_output)
end_multivariate <- grep("---", manyglm_output[start_multivariate:length(manyglm_output)])[[1]] + start_multivariate - 2

multivariate_lines <- manyglm_output[(start_multivariate + 1):end_multivariate]

# Convert to a data frame
multivariate_table <- read.table(text = multivariate_lines, header = FALSE, fill = TRUE)
colnames(multivariate_table) <- c("Variable", "Res.Df", "Df.diff", "Dev", "Pr(>Dev)", ' ')
multivariate_table <- multivariate_table[multivariate_table$Variable != 'Res.Df',] # Remove weird extra row

# Cleanup the names of variables
multivariate_table$Variable <- gsub("^sd$", "Sampling Design", multivariate_table$Variable)  # Replace 'sd' with 'Sampling Design'
multivariate_table$Variable <- gsub("^sd:", "Sampling Design:", multivariate_table$Variable)  # Replace 'sd:' with 'Sampling Design:'
multivariate_table$Variable <- str_to_title(multivariate_table$Variable)  # Capitalize all other names

# Preview the table
print(multivariate_table)

```

```{r manyglm_output_table, tab.cap = "Output table of the manyglm of community composition"}
gt_table <- gt(multivariate_table) %>%
  tab_header(
    title = "Manyglm model"
  ) %>%
  fmt_number(
    columns = c("Dev", `Pr(>Dev)`),  # Use backticks for special characters
    decimals = 3
  ) %>%
  tab_style(
    style = list(cell_text(weight = "bold")),
    locations = cells_body(columns = `Pr(>Dev)`, rows = `Pr(>Dev)` < 0.05)  # Backticks here too
  )
gt_table
```

```{r PCoA analysis, include = FALSE, echo = FALSE, message = FALSE, warning = FALSE}
## Load libraries -------------------------------------------------------------

library(vegan) # for community composition
library(tidyverse) # for data manipulation
library(mvabund) # for community analysis
library(sf) # for manipulating shapefiles
library(ggrepel) # for plots

## Load data and transform into OTU format ----------------------------------

# Files used in this script
file_analysis_box <- "QGIS layers/polys/com_comp_analysis_limits.shp"
file_all_maxn     <- "data/tidy/2024_geographe_all_tidy_maxn.csv"

# Box around East Geographe, we're only using this area to compare community.
crs <- st_crs(4326)
box <- st_read(file_analysis_box) %>%
  st_make_valid() %>%
  st_transform(crs)
plot(box)


# MaxN data

maxn <- read.csv(file_all_maxn) %>%
  pivot_wider(id_cols = c(opcode, latitude, longitude, depth, status, sd),
              names_from = fullspp, values_from = MaxN, values_fill = 0) %>%
  filter(!is.na(longitude) & !is.na(latitude)) %>%
  glimpse()
maxn <- st_as_sf(maxn, coords = c("longitude", "latitude"), crs = 4326); plot(maxn)

# Select only points within community composition box
com_comp <- st_intersection(maxn, box); plot(com_comp)
saveRDS(com_comp, 'data/rmd/com_comp_maxn.rds') # for rmarkdown

## PCoA -----------------------------------------------------------------------

# Separate environmental and abundance data
community_data <- as.data.frame(com_comp) %>%
  ungroup() %>%
  dplyr::select(!1:4 & !id & !geometry) %>% # Select only species columns
  mutate(across(everything(), ~replace_na(., 0))) %>%  # Replace NAs with zeroes
  glimpse()

environmental_data <- as.data.frame(com_comp) %>%
  ungroup() %>%
  dplyr::select(sd, depth, status) %>%
  mutate(sd = as.factor(sd),
         status = as.factor(status)) %>%
  glimpse()

# Perform Bray-Curtis distance
dist_matrix <- vegdist(community_data, method = "bray")

# Perform PCoA
pcoa_result <- cmdscale(dist_matrix, k = 2, eig = TRUE)  # k = 2 for two principal axes
pcoa_scores <- as.data.frame(pcoa_result$points); head(pcoa_scores)

pcoa_scores$sd <- com_comp$sd; pcoa_scores$status <- com_comp$status; pcoa_scores$depth <- com_comp$depth
head(pcoa_scores)

# Remove species with zero variance
species_data <- community_data[, apply(community_data, 2, sd) > 0]

# Check alignment of samples between species data and PCoA scores
rownames(species_data) <- rownames(pcoa_scores)  # Ensure rows match

# Calculate correlation between species data and PCoA axes
correlations <- cor(species_data, pcoa_scores[1:2])

# Create a data frame for species vectors
species_vectors <- data.frame(
  species = colnames(species_data),
  cor_PC1 = correlations[, 1],
  cor_PC2 = correlations[, 2]
)

# Set a threshold for correlation to filter major species (e.g., |correlation| > 0.35)
threshold <- 0.35
major_species <- species_vectors[apply(abs(species_vectors[, c("cor_PC1", "cor_PC2")]), 1, max) > threshold, ]
major_species$species <- ifelse(grepl("^(spp|sp1|sp|\\.spp)$", sub("^[^\\.]+\\.", "", major_species$species)),
                                major_species$species, 
                                sub("^[^\\.]+\\.", "", major_species$species))
major_species$species <- sub("\\.", "\n", major_species$species); major_species$species <- sub("\\.", "", major_species$species)

head(major_species)
```

```{r PCoA_plot, fig.cap = 'Principal Composite Analysis of community composition. Species vectors in red represent species with a correlation > 0.35.', echo = FALSE, message = FALSE, warning = FALSE}
ggplot(pcoa_scores, aes(x = V1, y = V2)) +
  geom_point(aes(alpha = depth, colour = sd, shape = status), size = 3) +
  scale_alpha_continuous(range = c(0.2, 1)) +
  scale_colour_manual(values = c("#f1c232", "#7f6000")) +
  theme_minimal() +
  geom_segment(data = major_species, aes(x = 0, y = 0, xend = cor_PC1, yend = cor_PC2), 
               arrow = arrow(type = "closed", length = unit(0.1, "inches")), color = "red", alpha = 0.5) +  # Add vectors
  geom_text_repel(data = major_species, aes(x = cor_PC1, y = cor_PC2, label = paste("italic('", species, "')", sep = "")), 
                  size = 3, box.padding = 1, point.padding = 0, 
                  max.overlaps = 20, segment.color = "red", 
                  vjust = 1, hjust = 1, parse = TRUE) +  # Italicize species names
  theme_minimal() +
  theme(
    legend.position = "right",
    legend.direction = "vertical",  
    legend.box.spacing = unit(0.5, "cm"),
    legend.key.height = unit(1, "lines"),
    legend.key.width = unit(1, "lines"),
    legend.text = element_text(size = 10),
    legend.title = element_text(size = 12),
    legend.spacing.x = unit(0.5, "cm"),
    axis.text = element_text(size = 12),
    axis.title = element_text(size = 16)
  ) +
  xlab("PC1") +
  ylab("PC2")
```

The PCoA and manyglm model highlighted differences in fish community composition between the two sampling designs (Figure \@ref(fig:PCoA_plot)). Community composition was significantly different between sampling design. A total of `r nrow(major_species)` species drove the pattern in the PCoA (correlation \> `r threshold`) (Figure \@ref(fig:PCoA_plot)). The effect of NTZ on community composition was not significant (Table \@ref(tab:manyglm_output_table)).

## Effect of sampling design on the detection of the NTZ effect of a single species

```{r gam_distribution_model, include = FALSE, echo = FALSE, message = FALSE, warning = FALSE}
library(mgcv)
library(broom)

dat <- readRDS('data/rmd/gam_model_data.rds')
best.model.name <- readRDS("data/rmd/gam_best_model.rds") # variables of best model, modify the gam below accordingly

m_mature <- gam(count_mature ~ # See 03_gam script for model selection process
                  s(detrended_250m, k = 3, bs = "cr") +
                  s(reef_250m, k = 3, bs = "cr") +
                  s(sand_250m, k = 3, bs = "cr"),
                data = dat, method = "REML", family = poisson(link = "log"))

summary(m_mature)

plot(m_mature, pages = 1, residuals = T, cex = 5)

gam.check(m_mature)
k.check(m_mature)

# Modify the gsub below to match variables in optimal model
tidy_model <- tidy(m_mature)
colnames(tidy_model) <- c("Variable", "Estimate", "Std. Error", "t value", "Pr(>|t|)")
tidy_model$Variable <- gsub("s\\(detrended_250m\\)", "Detrended bathymetry (250m resolution)", tidy_model$Variable)
tidy_model$Variable <- gsub("s\\(reef_250m\\)", "Reef (250m resolution)", tidy_model$Variable)
tidy_model$Variable <- gsub("s\\(sand_250m\\)", "Sand (250m resolution)", tidy_model$Variable)
tidy_model[2:5] <- round(tidy_model[2:5], 3)

```

```{r gam_table, tab.cap = "Generalised Additive model of *C.auratus* abundance", echo = FALSE, message = FALSE, warning = FALSE}
knitr::kable(tidy_model)

```

From all the BRUV samples, a distribution model was fitted to bathymetry and habitat covariates. The optimal model included sand, seagrass and detrended bathymetry as covariates, all from the 250m resolution dataset. The final model explained `r round(((1 - (deviance(m_mature) / deviance(update(m_mature, . ~ 1))))*100), 2)`% of deviance in the data.

```{r sampling_design_performance_mean_abundance, include = FALSE, echo = FALSE, message = FALSE, warning = FALSE}
SD_points <- readRDS('data/rmd/SD_points.rds')

library(tidyverse)
library(kableExtra)

summary_table <- SD_points %>%
  group_by(SD, in_SZ) %>%
  # Summarize the mean random abundances for before and after
  summarize(
    mean_random_abundance_before = mean(random_abundance_before, na.rm = TRUE),
    mean_random_abundance_after = mean(random_abundance_after, na.rm = TRUE),
    .groups = "drop"  # Remove grouping after summarizing
  ) %>%
  # Pivot the data to have SD as rows and before/after as columns
  pivot_wider(
    names_from = in_SZ, 
    values_from = c(mean_random_abundance_before, mean_random_abundance_after),
    names_glue = "{in_SZ}_{.value}"
  ) %>%
  # Recode SD names for clarity
  mutate(SD = recode(SD, 
                     "pref" = "Preferential", 
                     "spabal" = "Spatially Balanced")) %>% 
  glimpse()
summary_table[2:5] <- round(summary_table[2:5], 3)

```

```{r sampling_design_mean_abundance_summary_table, tab.cap= 'Mean abundance obtained from the 2000 sampling design simulations.', echo = FALSE, message = FALSE, warning = FALSE}
summary_table %>%
  kable("html", col.names = c("SD", "Fished", "No-take", "Fished", "No-Take")) %>%
  kable_styling("striped", full_width = TRUE) %>%
  add_header_above(c(" " = 1, "Before" = 2, "After" = 2), align = "c")  # Add custom header row

```

```{r sampling_design_performance_%_correct, include = FALSE, echo = FALSE, message = FALSE, warning = FALSE}
SD_points <- readRDS('data/rmd/SD_points.rds')

dat <- SD_points %>% # Re-organising the dataframe so it's easier to work with.
  pivot_longer(
    cols = c(random_abundance_before, random_abundance_after),
    names_to = "BA",
    values_to = "random_abundance"
  ) %>%
  mutate(BA = recode(BA, "random_abundance_before" = "before", "random_abundance_after" = "after")) %>%
  dplyr::select(c(ID_1, design_id, SD, BA, random_abundance, in_SZ)) %>%
  glimpse()

ratio_CI <- dat %>%
  group_by(design_id, SD, BA, in_SZ) %>%
  filter(in_SZ == 'TRUE') %>% 
  summarize(mean_random_abundance = mean(random_abundance, na.rm = TRUE)) %>%
  spread(key = BA, value = mean_random_abundance) %>%
  mutate(abundance_ratio = `after` / `before`) %>% 
  ungroup() %>% 
  glimpse()

ratio_BACI <- dat %>%
  group_by(design_id, SD, BA, in_SZ) %>%
  summarize(mean_random_abundance = mean(random_abundance, na.rm = TRUE)) %>%
  spread(key = in_SZ, value = mean_random_abundance) %>%
  mutate(abundance_ratio = `TRUE` / `FALSE`) %>% 
  ungroup() %>% 
  group_by(design_id, SD) %>% # Group by design_id and SD
  summarize(
    abundance_ratio_diff = abundance_ratio[BA == 'after'] - abundance_ratio[BA == 'before'],
    .groups = "drop" # Ensures the result is not grouped
  ) %>%
  glimpse()

percentage_CI <- ratio_CI %>%
  filter(abundance_ratio >= 1.8*0.9 & abundance_ratio <= 1.8*1.1) %>% # i want only the ratios that are within 10% of the 1.8x increase.
  group_by(SD) %>%  # Group by SD
  summarise(
    perc = n() / nrow(ratio_CI %>% filter(SD == SD)) * 100  # Calculate percentage that's within 10% of 1.8x increase
  )
glimpse(percentage_CI) # That is terrible performance my dude.
  

percentage_BACI <- ratio_BACI %>%
  filter(abundance_ratio_diff >= 0.8*0.9 & abundance_ratio_diff <= 0.8*1.1) %>% # i want only the ratios that are within 10% of the 1.8x increase.
  group_by(SD) %>%  # Group by SD
  summarise(
    perc = n() / nrow(ratio_BACI %>% filter(SD == SD)) * 100  # Calculate percentage that's within 10% of 1.8x increase
  )
glimpse(percentage_BACI) # That is terrible performance my dude.

```

```{r ratio_barplot, fig.cap = "Histogram of the Control-Impact (CI) and Before-After-Control-Impact (BACI) comparisons. The red dashed line indicates the true ratio (1.8 for CI, and 0.8 for BACI), and the red box indicates 10% either side of the true ratio.", echo = FALSE, message = FALSE, warning = FALSE}
library(ggplot2)
library(cowplot)

# BACI plot
BACI <- ggplot(ratio_BACI, aes(x = abundance_ratio_diff, fill = SD)) +
  geom_histogram(bins = 30, position = "dodge", alpha = 0.7) +
  facet_wrap(~ SD, 
             labeller = labeller(SD = c("pref" = "Preferential", 
                                        "spabal" = "Spatially Balanced"))) +
  scale_fill_manual(values = c("pref" = "#f1c232", 
                               "spabal" = "#7f6000")) +
  theme_minimal() +  
  theme(
    legend.position = "none",
    plot.title = element_text(hjust = 0.5, face = 'bold'),  # Center title
    axis.title.x = element_blank(),
    axis.title.y = element_blank()
  ) +
  labs(
    title = "Before-After-Control-Impact") +
  geom_vline(xintercept = 0.8, color = "red", linetype = "dashed", linewidth = 1) +
  annotate("rect", xmin = 0.9 * 0.8, xmax = 1.1 * 0.8, ymin = -Inf, ymax = Inf,
           fill = "red", alpha = 0.2)  # The correct ratio is 0.8 for BACI

# CI plot
CI <- ggplot(ratio_CI, aes(x = abundance_ratio, fill = SD)) +
  geom_histogram(bins = 30, position = "dodge", alpha = 0.7) +
  facet_wrap(~ SD, 
             labeller = labeller(SD = c("pref" = "Preferential", 
                                        "spabal" = "Spatially Balanced"))) +
  scale_fill_manual(values = c("pref" = "#f1c232", 
                               "spabal" = "#7f6000")) +
  theme_minimal() +  
  theme(
    legend.position = "none",
    plot.title = element_text(hjust = 0.5, face = 'bold'),  # Center title
    axis.title.x = element_blank(),
    axis.title.y = element_blank()
  ) +
  labs(
    title = "Control-Impact") +
  geom_vline(xintercept = 1.8, color = "red", linetype = "dashed", linewidth = 1) +
  annotate("rect", xmin = 0.9 * 1.8, xmax = 1.1 * 1.8, ymin = -Inf, ymax = Inf,
           fill = "red", alpha = 0.2)  # The correct ratio is 1.8 for CI

combined_plot <- plot_grid(
  CI, BACI,
  ncol = 1,
  align = "h",
  rel_heights = c(0.5, 0.5)
)

# Add common axis labels with extra margin
combined_plot + 
  draw_label("Response Ratio", x = 0.5, y = 0, hjust = 0.5, vjust = 0.5) +
  draw_label("Number of Simulations", x = 0, y = 0.5, hjust = 0.5, vjust = 0.5, angle = 90) +
  theme(
    plot.margin = margin(20, 20, 40, 20)
  )

```


### Spatially balanced sampling design performance

Simulations of the spatially balanced sampling design detected on average `r round(mean(SD_points$random_abundance_after[SD_points$SD == 'spabal' & SD_points$in_SZ == TRUE]) / mean(SD_points$random_abundance_after[SD_points$SD == 'spabal' & SD_points$in_SZ == FALSE]), 2)` times more fish inside the NTZ than outside (inside: `r round(mean(SD_points$random_abundance_after[SD_points$SD == 'spabal' & SD_points$in_SZ == TRUE]), 2)`, outside: `r round(mean(SD_points$random_abundance_after[SD_points$SD == 'spabal' & SD_points$in_SZ == FALSE]), 2)`). The CI comparison correctly detected the 80% (+/- 10%) increase in abundance `r round(percentage_CI$perc[percentage_CI$SD=="spabal"], 2)`% of the time for spatially balanced designs. The BACI comparison correctly detected the 80% (+/- 10%) increase in abundance `r round(percentage_BACI$perc[percentage_BACI$SD=="spabal"], 2)`% of the time for spatially balanced designs. (Figure \@ref(fig:ratio_barplot))

In the CI comparison, the ratio in the modelled abundance ratio of Yijarup/Pink Snapper inside and outside the simulated NTZ was underestimated in `r (sum(ratio_CI$abundance_ratio[ratio_CI$SD == 'spabal'] < (0.9 * 1.8))/sum(ratio_CI$SD == 'spabal'))*100`% and overestimated in `r (sum(ratio_CI$abundance_ratio[ratio_CI$SD == 'spabal'] > (1.1 * 1.8))/sum(ratio_CI$SD == 'spabal'))*100`% of spatially balanced simulations. In the BACI comparison, the difference in the modelled abundance ratio of Yijarup/Pink Snapper inside and outside the simulated NTZ before and after the abundance increase was underestimated in `r (sum(ratio_BACI$abundance_ratio_diff[ratio_BACI$SD == 'spabal'] < (0.9 * 0.8))/sum(ratio_BACI$SD == 'spabal'))*100`% and overestimated in `r (sum(ratio_BACI$abundance_ratio_diff[ratio_BACI$SD == 'spabal'] > (1.1 * 0.8))/sum(ratio_BACI$SD == 'spabal'))*100`% of spatially balanced simulations. (Figure \@ref(fig:ratio_barplot))


### Preferential sampling design performance

Simulations of the preferential sampling design detected on average `r round(mean(SD_points$random_abundance_after[SD_points$SD == 'pref' & SD_points$in_SZ == TRUE]) / mean(SD_points$random_abundance_after[SD_points$SD == 'pref' & SD_points$in_SZ == FALSE]), 2)` times more fish inside the NTZ than outside (inside: `r round(mean(SD_points$random_abundance_after[SD_points$SD == 'pref' & SD_points$in_SZ == TRUE]), 2)`, outside: `r round(mean(SD_points$random_abundance_after[SD_points$SD == 'pref' & SD_points$in_SZ == FALSE]), 2)`). The CI comparison correctly detected the 80% (+/- 10%) increase in abundance `r round(percentage_CI$perc[percentage_CI$SD=="pref"], 2)`% of the time for preferential designs. The BACI comparison correctly detected the 80% (+/- 10%) increase in abundance `r round(percentage_BACI$perc[percentage_BACI$SD=="pref"], 2)`% of the time for spatially balanced designs. (Figure \@ref(fig:ratio_barplot))

In the CI comparison, the ratio in the modelled abundance ratio of Yijarup/Pink Snapper inside and outside the simulated NTZ was underestimated in `r (sum(ratio_CI$abundance_ratio[ratio_CI$SD == 'pref'] < (0.9 * 1.8))/sum(ratio_CI$SD == 'pref'))*100`% and overestimated in `r (sum(ratio_CI$abundance_ratio[ratio_CI$SD == 'pref'] > (1.1 * 1.8))/sum(ratio_CI$SD == 'pref'))*100`% of preferential simulations. In the BACI comparison, the difference in the modelled abundance ratio of Yijarup/Pink Snapper inside and outside the simulated NTZ before and after the abundance increase was underestimated in `r (sum(ratio_BACI$abundance_ratio_diff[ratio_BACI$SD == 'pref'] < (0.9 * 0.8))/sum(ratio_BACI$SD == 'pref'))*100`% and overestimated in `r (sum(ratio_BACI$abundance_ratio_diff[ratio_BACI$SD == 'pref'] > (1.1 * 0.8))/sum(ratio_BACI$SD == 'pref'))*100`% of preferential simulations. (Figure \@ref(fig:ratio_barplot))



# Discussion

In this study, the performance of preferential and spatially balanced BRUV sampling designs are compared as MPA monitoring tools for single species detection and community composition at the local scale. Results highlight the importance of sampling design choice for BRUV studies, and how both designs may under- or over-estimate the effects of NTZs on single target species such as Yijarup/Pink Snapper at this scale.


## Community composition

The significant difference in community composition between sampling designs is not surprising, as the spacing and distribution of points within the sampling area is quite different between the two. The habitat association of communities, and the variety of habitat across the sampling area likely means that the preferential design sampled a restricted range of habitat, thus detecting this habitat's community very well. In contrast, the spatially balanced design may have sampled a wider range of habitats, detecting the whole sampling area's community well overall, but individual habitats' communities less thoroughly. @Alessi2023 found the same conclusions when simulating the performance of preferential and probabilistic sampling designs on vegetation communities. They found that preferential sampling detected 'habitat specialist species' better, but the probabilistic sampling design detected the richness and diversity of the study area better. This could be roughly summarised as a difference in number of samples per habitat, which alters the accuracy of estimates in population ecology [@Stockwell2002]. In multivariate community composition analyses like the present study, sample size is just as important, as trends for multiple species must be detected: @Irvine2011 simulated the detection ability of different multivariate tests on community composition, and found that sample size had a large effect on trend detection, regardless of the community trend (increasing/decreasing and mixed trend) or the multivariate test.

As a result, a choice must be made between sampling a single habitat very well (like the preferential design) or capturing more habitats perhaps less well (like the spatially balanced design). In the context of MPA monitoring, the added challenge of placing samples so that the effect of the MPA can be assessed correctly complicates things. On a local scale, habitats are heterogeneous and MPAs may be placed to optimise conservation outcomes (= on attractive and biodiverse features, not necessarily representing all habitats at this scale, @Stevens2005), or avoid fishing grounds (= on areas less threatened or less biodiverse, described as 'low hanging fruit' by @Agardy2011). Measuring the effect of an MPA on community composition using preferential sampling would require the same features to exist inside and outside the MPA, or an identical unprotected site to be sampled to pair with the MPA site, which is rarely possible, and rarely done in studies [@Osenberg2006; @Underwood1991]. Comparatively, spatially balancing samples allows for the categorisation of the area not in features, but in geomorphology (or other environmental variable) strata, which can be more even and spatially representative in the distribution of samples, and allow the assessment of an MPA effect.


## Single species detection

A very small portion of simulations correctly detected the 80% increase in abundance within the NTZ (Figure \@ref(fig:ratio_barplot)), regardless of the comparison type (CI or BACI). This performance may be due to the fish's mobility (encompassed in the simulation as a detection within the Normal distribution of the model), and the uncertainty associated with detecting a number of fish in the BRUV reflective of the true abundance of the area. The scale of study may explain the similarity in performance, as the differences in Yijarup/Pink Snapper abundance over this local scale may be too small to show through the 'mobility' of the fish. Although both comparisons performed poorly, more designs performed well under the CI comparison, compared to the BACI comparison. (expand here, there's some significance I think)

An element of concern in the performance of the sampling design simulations is the large portion of simulations (\>50%) to overestimate the increase in abundance within the NTZ. A study by @Ovando2021 criticises the use of response ratios to assess population effects of MPAs, as they find they are susceptible to inaccuracy when assessing population-level effects. Their simulations find that a response ratio of 50% was produced in a majority of cases by a population effect of \<10% (median 2.5%), greatly overestimating the MPA effect on populations. This study also describes the difficulty of detecting MPA effects when effect sizes are small, which may be the case depending on the size of the NTZ, the pressures on this specific area etc.. Even with an 80% increase in abundance within the simulated NTZ, `r (sum(ratio_BACI$abundance_ratio_diff[ratio_BACI$SD == 'pref'] < 0)/sum(ratio_BACI$SD == 'spabal'))*100`% of BACI preferential simulations and `r (sum(ratio_BACI$abundance_ratio_diff[ratio_BACI$SD == 'spabal'] < 0)/sum(ratio_BACI$SD == 'spabal'))*100`% of BACI spatially balanced simulations do not find an increase in the NTZ (response ratio \<0, Figure \@ref(fig:ratio_barplot)). The use of multiple metrics is essential to correctly describe the performance of MPAs, and to avoid relying on the inaccuracy of one.

Several elements may have contributed to the sampling designs performing similarly: First, Waatern/Geographe Bay has very gentle geomorphology, with few striking features to create attractive habitat in the simulation area. Second, Yijarup/Pink Snapper in this study appears to be a spatially generalist species with even affinity to environmental variables in the simulation area, making the spatial distribution difference between the sampling designs close to irrelevant. This contrasts with existing literature on Yijarup/Pink Snapper habitat affinity [@Parsons2016; @Terres2015]. The shallow depth of the simulation area may have also played a role in the low and even abundance of mature fish in the model [@Heyns2016]. In a species with stricter affinities to geomorphology and habitat, and a study site with more prominent geomorphology features and habitat differences, the predicted abundance of the species would be less even over the simulation area, and the difference between sampling designs is likely to be much bigger.

## Implication

(expand on: managers need to choose a SD, there is no right answer? depending on the thing you're more interested in)


### Recommendations
